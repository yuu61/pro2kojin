# ローカル型バージョン管理システム

## 概要
最小限の機能を持つローカル専用のバージョン管理システム。Gitの基本概念を学ぶための教育的プロジェクト。

## 開発方針
このプロジェクトは**学習を目的**としているため、以下の方針で進めます:
- **可能な限り自力で実装** - 基本的なロジックやアルゴリズムは自分で考えて書く
- **AIは補助的に活用** - 設計レビュー、バグ修正のヒント、API使用方法の確認など
- **完璧を目指さない** - 動作する最小限の機能を優先し、段階的に改善
- **写経ではなく理解** - コードの意味を理解しながら実装を進める

### AIとの付き合い方
- ✅ アーキテクチャやデータ構造の設計相談
- ✅ エラーメッセージの解釈やデバッグのヒント
- ✅ OpenSSL APIなどライブラリの使い方確認
- ⚠️ コード全体の自動生成は最小限に
- ❌ 理解せずにコピペ

## 現在の実装状況
- ✅ リポジトリ初期化 (`initRepository`)
- ✅ SHA1ハッシュ生成 (`hashGen`)
- ⚠️ ハッシュ生成にバグあり(SHA1_Initの呼び出し漏れ、BUFFER_SIZE未定義)

## アーキテクチャ

### ディレクトリ構造
```
.vcs/                    # リポジトリルート
├── stageDir/           # ステージングエリア
│   └── [ハッシュ値]    # ステージされたファイルのコピー
└── commitDir/           # コミット履歴
    ├── [コミットID]/   # 各コミットのスナップショット
    │   ├── files/      # コミット時のファイル群
    │   └── meta.txt    # メタデータ(日時、メッセージ)
    └── HEAD.txt        # 最新コミットのID
```

## ロードマップ

### Phase 1: 基本機能の修正と実装 (最優先)
1. **バグ修正**
   - [ ] `BUFFER_SIZE`マクロを定義 (推奨: 4096)
   - [ ] `hashGen`に`SHA1_Init(&shaContext)`の呼び出しを追加
   - [ ] `printf`のフォーマット文字列修正 (`%s`でFILE*を出力しようとしている)

2. **add機能 (ステージング)**
   - [ ] ファイルをstageDir/にコピー
   - [ ] ファイル名とハッシュ値の対応をindex.txtに記録
   - [ ] コマンド: `add <ファイルパス>`

3. **commit機能**
   - [ ] stageDirの内容からコミットIDを生成(全体のハッシュ)
   - [ ] commitDir/[コミットID]/にスナップショットを保存
   - [ ] meta.txtにタイムスタンプとメッセージを記録
   - [ ] HEADを更新
   - [ ] コマンド: `commit "<メッセージ>"`

### Phase 2: 履歴管理
4. **log機能**
   - [ ] commitDir/を走査して全コミット履歴を表示
   - [ ] 各コミットのID、日時、メッセージを表示
   - [ ] コマンド: `log`

5. **status機能**
   - [ ] 現在のHEADを表示
   - [ ] stageDir/の内容を表示(ステージされたファイル一覧)
   - [ ] コマンド: `status`

### Phase 3: 復元機能
6. **checkout機能**
   - [ ] 指定したコミットIDのスナップショットを作業ディレクトリに復元
   - [ ] HEADを移動
   - [ ] コマンド: `checkout <コミットID>`

7. **diff機能 (オプション)**
   - [ ] 2つのコミット間の差分を簡易表示
   - [ ] ファイルの追加/削除/変更を検出
   - [ ] コマンド: `diff <コミットID1> <コミットID2>`

## コマンド仕様

### 基本コマンド
```
> init <リポジトリパス>     # リポジトリ初期化
> add <ファイルパス>        # ファイルをステージング
> commit "<メッセージ>"     # コミット作成
> status                    # 現在の状態を表示
> log                       # コミット履歴を表示
> checkout <コミットID>     # 指定コミットに移動
> exit                      # 終了
```

### コマンドパーサーの実装方針
- `strtok()`で空白区切りで分割
- 第1引数がコマンド名、第2引数以降がオプション/引数
- 引用符内の文字列は一つの引数として扱う

## データ構造

### index.txt (stageDir/index.txt)
```
<ファイルパス> <SHA1ハッシュ>
<ファイルパス> <SHA1ハッシュ>
...
```

### meta.txt (commitDir/[コミットID]/meta.txt)
```
timestamp: 2025-12-04 10:30:45
message: 初回コミット
parent: <親コミットID または none>
```

### HEAD.txt (commitDir/HEAD.txt)
```
<現在のコミットID>
```

## 実装のヒント

### ファイルコピー
- `fopen`でソースを"rb"、デスティネーションを"wb"で開く
- バッファを使って読み書き

### コミットID生成
- index.txtの全内容 + タイムスタンプをSHA1ハッシュ化
- 最初の8文字を使用(短縮版)

### エラーハンドリング
- ファイルオープン失敗時のチェック
- ディレクトリ作成失敗時のチェック
- 存在しないコミットIDへのcheckout時のエラー

## 除外する機能(簡略化のため)
- ❌ ブランチ機能
- ❌ マージ機能
- ❌ リモートリポジトリ連携
- ❌ .gitignore的な除外機能
- ❌ 差分アルゴリズム(diffは単純な有無のみ)

## 学習ポイント
- ファイルシステム操作
- ハッシュ関数の利用
- データの永続化
- コマンドラインパーサー
- バージョン管理の基本概念

## 次のステップ
1. Phase 1のバグ修正から着手
2. `add`コマンドの実装
3. 小さく動作確認しながら進める
4. 各機能ごとにテストケースを考える

---
**注意**: このシステムはOpenSSLのSHA1を使用しています。ビルド時に`-lssl -lcrypto`のリンクが必要です。
